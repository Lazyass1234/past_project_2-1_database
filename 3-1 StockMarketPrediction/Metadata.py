import pandas as pd
from os import listdir

data_dir = "KOSPI_daily"
file_list = listdir(data_dir)

def df_tk_list():
    drop_list = []
    for i in range(len(file_list)-1): #20-1
        temp_csv_p = pd.read_csv(data_dir+"//"+file_list[i]).set_index('Ticker')
        temp_csv_p.drop('Name', inplace=True, axis=1)
        temp_csv_l = pd.read_csv(data_dir+"//"+file_list[i+1]).set_index('Ticker')
        temp_csv_l.drop('Name', inplace=True, axis=1)
        for ticker in temp_csv_p.index.tolist(): #ticker code
            if ticker not in temp_csv_l.index.tolist():
                drop_list.append(ticker)
        for ticker in temp_csv_l.index.tolist():
            if ticker not in temp_csv_p.index.tolist():
                drop_list.append(ticker)
                
    series_list = []#a list of numpy arrays time series ordered
    for i in range(len(file_list)):
        temp_csv_c = pd.read_csv(data_dir+"//"+file_list[i]).set_index('Ticker')
        temp_csv_c.drop('Name', inplace=True, axis=1)
        for ticker in temp_csv_c.index.tolist(): #ticker code
            if ticker in drop_list:
                temp_csv_c = temp_csv_c.drop(ticker)
                #DataFrame
        list_daily = temp_csv_c.values.tolist()
        series_list.append(list_daily)
    
    df_list = []
    ticker_list = []
    n = 0
    for ticker in temp_csv_c.index.tolist():
        df_list.append(str("y%s_"%ticker)+str(n))
        df_list[n] = pd.DataFrame(columns=['Cl'])
        n += 1
        ticker_list.append(ticker)
    for i in range(len(df_list)):
        cl_list = []
        for d in series_list: # d for daily_list
            cl_list.append([d[i][3]])
        df_list[i] = pd.DataFrame(cl_list, columns=['Cl'])
    return df_list, ticker_list

#days = 814, companies = 845
df_list, ticker_list = df_tk_list()
print(df_list[0].head())
dates = ["20180102","20180103","20180104","20180105","20180108","20180109","20180110",
         "20180111","20180112","20180115","20180116","20180117","20180118","20180119",
         "20180122","20180123","20180124","20180125","20180126","20180129","20180130","20180131",
         "20180201","20180202","20180205","20180206","20180207","20180208","20180209",
         "20180212","20180213","20180214","20180219","20180220",
         "20180221","20180222","20180223","20180226","20180227","20180228",
         "20180302","20180305","20180306","20180307","20180308","20180309",
         "20180312","20180313","20180314","20180315","20180316","20180319","20180320",
         "20180321","20180322","20180323","20180326","20180327","20180328","20180329","20180330",
         "20180402","20180403","20180404","20180405","20180406","20180409","20180410",
         "20180411","20180412","20180413","20180416","20180417","20180418","20180419","20180420",
         "20180423","20180424","20180425","20180426","20180427","20180430",
         "20180502","20180503","20180504","20180508","20180509","20180510",
         "20180511","20180514","20180515","20180516","20180517","20180518",
         "20180521","20180523","20180524","20180525","20180528","20180529","20180530","20180531",
         "20180601","20180604","20180605","20180607","20180608",
         "20180611","20180612","20180614","20180615","20180618","20180619","20180620",
         "20180621","20180622","20180625","20180626","20180627","20180628","20180629",
         "20180702","20180703","20180704","20180705","20180706","20180709","20180710",
         "20180711","20180712","20180713","20180716","20180717","20180718","20180719","20180720",
         "20180723","20180724","20180725","20180726","20180727","20180730","20180731",
         "20180801","20180802","20180803","20180806","20180807","20180808","20180809","20180810",
         "20180813","20180814","20180816","20180817","20180820",
         "20180821","20180822","20180823","20180824","20180827","20180828","20180829","20180830","20180831",
         "20180903","20180904","20180905","20180906","20180907","20180910",
         "20180911","20180912","20180914","20180917","20180918","20180919","20180920",
         "20180921","20180927","20180928",
         "20181001","20181002","20181004","20181005","20181008","20181010",
         "20181011","20181012","20181015","20181016","20181017","20181018","20181019",
         "20181022","20181023","20181024","20181025","20181026","20181029","20181030","20181031",
         "20181101","20181102","20181105","20181106","20181107","20181108","20181109",
         "20181112","20181113","20181114","20181115","20181116","20181119","20181120",
         "20181121","20181122","20181123","20181126","20181127","20181128","20181129","20181130",
         "20181203","20181204","20181205","20181206","20181207","20181210",
         "20181211","20181212","20181213","20181214","20181217","20181218","20181219","20181220",
         "20181221","20181224","20181226","20181227","20181228",
         
         "20190102","20190103","20190104","20190107","20190108","20190109","20190110",
         "20190111","20190114","20190115","20190116","20190117","20190118",
         "20190121","20190122","20190123","20190124","20190125","20190128","20190129","20190130","20190131",
         "20190201","20190207","20190208",
         "20190211","20190212","20190213","20190214","20190215","20190218","20190219","20190220",
         "20190221","20190222","20190225","20190226","20190227","20190228",
         "20190304","20190305","20190306","20190307","20190308",
         "20190311","20190312","20190313","20190314","20190315","20190318","20190319","20190320",
         "20190321","20190322","20190325","20190326","20190327","20190328","20190329",
         "20190401","20190402","20190403","20190404","20190405","20190408","20190409","20190410",
         "20190411","20190412","20190415","20190416","20190417","20190418","20190419",
         "20190422","20190423","20190424","20190425","20190426","20190429","20190430",
         "20190502","20190503","20190507","20190508","20190509","20190510",
         "20190513","20190514","20190515","20190516","20190517","20190520",
         "20190521","20190522","20190523","20190524","20190527","20190528","20190529","20190530","20190531",
         "20190603","20190604","20190605","20190607","20190610",
         "20190611","20190612","20190613","20190614","20190617","20190618","20190619","20190620",
         "20190621","20190624","20190625","20190626","20190627","20190628",
         "20190701","20190702","20190703","20190704","20190705","20190708","20190709","20190710",
         "20190711","20190712","20190715","20190716","20190717","20190718","20190719",
         "20190722","20190723","20190724","20190725","20190726","20190729","20190730","20190731",
         "20190801","20190802","20190805","20190806","20190807","20190808","20190809",
         "20190812","20190813","20190814","20190816","20190819","20190820",
         "20190821","20190822","20190823","20190826","20190827","20190828","20190829","20190830",
         "20190902","20190903","20190904","20190905","20190906","20190909","20190910",
         "20190911","20190916","20190917","20190918","20190919","20190920",
         "20190923","20190924","20190925","20190926","20190927","20190930",
         "20191001","20191002","20191004","20191007","20191008","20191010",
         "20191011","20191014","20191015","20191016","20191017","20191018",
         "20191021","20191022","20191023","20191024","20191025","20191028","20191029","20191030","20191031",
         "20191101","20191104","20191105","20191106","20191107","20191108",
         "20191111","20191112","20191113","20191114","20191115","20191118","20191119","20191120",
         "20191121","20191122","20191125","20191126","20191127","20191128","20191129",
         "20191202","20191203","20191204","20191205","20191206","20191209","20191210",
         "20191211","20191212","20191213","20191216","20191217","20191218","20191219","20191220",
         "20191223","20191224","20191226","20191227","20191230",
         
         "20200102","20200103","20200106","20200107","20200108","20200109","20200110",
         "20200113","20200114","20200115","20200116","20200117","20200120",
         "20200121","20200122","20200123","20200128","20200129","20200130","20200131",
         "20200203","20200204","20200205","20200206","20200207","20200210",
         "20200211","20200212","20200213","20200214","20200217","20200218","20200219","20200220",
         "20200221","20200224","20200225","20200226","20200227","20200228",
         "20200302","20200303","20200304","20200305","20200306","20200309","20200310",
         "20200311","20200312","20200313","20200316","20200317","20200318","20200319","20200320",
         "20200323","20200324","20200325","20200326","20200327","20200330","20200331",
         "20200401","20200402","20200403","20200406","20200407","20200408","20200409","20200410",
         "20200413","20200414","20200416","20200417","20200420",
         "20200421","20200422","20200423","20200424","20200427","20200428","20200429",
         "20200504","20200506","20200507","20200508",
         "20200511","20200512","20200513","20200514","20200515","20200518","20200519","20200520",
         "20200521","20200522","20200525","20200526","20200527","20200528","20200529",
         "20200601","20200602","20200603","20200604","20200605","20200608","20200609","20200610",
         "20200611","20200612","20200615","20200616","20200617","20200618","20200619",
         "20200622","20200623","20200624","20200625","20200626","20200629","20200630",
         "20200701","20200702","20200703","20200706","20200707","20200708","20200709","20200710",
         "20200713","20200714","20200715","20200716","20200717","20200720",
         "20200721","20200722","20200723","20200724","20200727","20200728","20200729","20200730","20200731",
         "20200803","20200804","20200805","20200806","20200807","20200810",
         "20200811","20200812","20200813","20200814","20200818","20200819","20200820",
         "20200821","20200824","20200825","20200826","20200827","20200828","20200831",
         "20200901","20200902","20200903","20200904","20200907","20200908","20200909","20200910",
         "20200911","20200914","20200915","20200916","20200917","20200918",
         "20200921","20200922","20200923","20200924","20200925","20200928","20200929",
         "20201005","20201006","20201007","20201008",
         "20201012","20201013","20201014","20201015","20201016","20201019","20201020",
         "20201021","20201022","20201023","20201026","20201027","20201028","20201029","20201030",
         "20201102","20201103","20201104","20201105","20201106","20201109","20201110",
         "20201111","20201112","20201113","20201116","20201117","20201118","20201119","20201120",
         "20201123","20201124","20201125","20201126","20201127","20201130",
         "20201201","20201202","20201203","20201204","20201207","20201208","20201209","20201210",
         "20201211","20201214","20201215","20201216","20201217","20201218",
         "20201221","20201222","20201223","20201224","20201228","20201229",
         
         "20201230","20210104","20210105","20210106","20210107","20210108",
         "20210111","20210112","20210113","20210114","20210115","20210118","20210119","20210120",
         "20210121","20210122","20210125","20210126","20210127","20210128","20210129",
         "20210201","20210202","20210203","20210204","20210205","20210208","20210209","20210210",
         "20210215","20210216","20210217","20210218","20210219",
         "20210222","20210223","20210224","20210225","20210226",
         "20210302","20210303","20210304","20210305","20210308","20210309","20210310",
         "20210311","20210312","20210315","20210316","20210317","20210318","20210319",
         "20210322","20210323","20210324","20210325","20210326","20210329","20210330","20210331",
         "20210401","20210402","20210405","20210406","20210407","20210408","20210409",
         "20210412","20210413","20210414","20210415","20210416","20210419","20210420",
         "20210421","20210422","20210423"]

for i in range(len(dates)):
    dates[i] = dates[i][:4] + '-' + dates[i][4:]
    dates[i] = dates[i][:7] + '-' + dates[i][7:]
newdf = pd.DataFrame(index = dates)
for i in range(845):
    df_list[i] = df_list[i].rename(columns = {'Cl': ticker_list[i]})
    df_list[i]['dates'] = dates
    df_list[i] = df_list[i].set_index('dates')
    newdf = pd.concat([newdf, df_list[i]], axis=1, join='inner')
    print(i)
#newdf = pd.concat([df_list[0]], axis=1, join='inner')
newdf.to_csv('metadata.csv', mode='w')